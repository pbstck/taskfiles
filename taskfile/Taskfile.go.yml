version: '3'

#internal: true

includes:
  common:
    taskfile: ./Taskfile.common.yml

tasks:
  build:
    deps: [ common:bin ]
    requires:
      vars: [ BINARIES_NAME ]
    cmds:
      - for: { var: BINARIES_NAME }
        cmd: CGO_ENABLED=0 GOOS=linux go build -a -installsuffix nocgo -o bin/ . && zip -r9 {{.USER_WORKING_DIR}}/bin/{{.ITEM}}.zip bin/{{.ITEM}}

  ecr-login:
    internal: true
    cmds:
      - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 563565546264.dkr.ecr.eu-west-1.amazonaws.com

  test:
    cmds:
      - go test -v ./...


  lint/check:
    cmds:
      - gofmt -l -s ./ && [ -z "$(gofmt -l -s ./)" ]

  lint/format:
    cmds:
      - gofmt -l -s -w ./

  artifact/mock:
    cmds:
      - for: { var: BINARIES_NAME }
        cmd: touch {{.USER_WORKING_DIR}}/bin/{{.ITEM}}.zip

  artifact/deliver:
    cmds:
      - task: common:artifact/deliver

  artifact/retrieve:
    cmds:
      - task: common:artifact/retrieve