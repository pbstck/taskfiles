version: '3'

internal: true

vars:
  RUST_WORKSPACE_DIR: "{{.ROOT_DIR}}/code/rust"

includes:
  common:
    taskfile: ./Taskfile.common.yml

tasks:
  build:
    deps: [ common:bin ]
    requires:
      vars: [ BINARY_NAME, RUST_WORKSPACE_DIR ]
    cmds:
      - cargo build --target x86_64-unknown-linux-gnu --release
      - cp {{.RUST_WORKSPACE_DIR}}/target/x86_64-unknown-linux-gnu/release/{{.BINARY_NAME}} ./bootstrap && zip -r {{.ROOT_DIR}}/bin/{{.BINARY_NAME}}.zip ./bootstrap
      - rm ./bootstrap

  test:
    cmds:
      - cargo test

  test/coverage:
    cmds:
      - cargo tarpaulin --out Xml --lib  --skip-clean


  lint/check:
    cmds:
      - cargo fmt -- --check
      - cargo clippy -- -D warnings

  lint/format:
    cmds:
      - cargo fmt
      - cargo clippy -- -D warnings


  artifact/mock:
    deps: [common:bin]
    cmds:
      - for: { var: BINARY_NAME }
        cmd: touch {{.USER_WORKING_DIR}}/bin/{{.ITEM}}.zip

  artifact/deliver:
    cmds:
      - task: common:artifact/deliver

  artifact/retrieve:
    cmds:
      - task: common:artifact/retrieve